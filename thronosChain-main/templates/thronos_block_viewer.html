<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Thronos Block & TX Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --g:#00ff66; --bg:#000; --panel:#0b0b0b; --dim:#0a0a0a; }
    * { box-sizing: border-box; }
    body { margin:0; background:var(--bg); color:var(--g); font-family:monospace; }
    nav { background:#111; padding:10px; display:flex; gap:14px; align-items:center; }
    nav a { color:var(--g); text-decoration:none; }
    .wrap { padding:14px; max-width:1200px; margin:0 auto; }
    h1 { margin:10px 0 14px; }
    .toolbar { display:flex; gap:10px; align-items:center; flex-wrap:wrap; margin-bottom:12px; }
    .btn {
      background:var(--panel); border:1px solid var(--g); color:var(--g);
      padding:8px 12px; cursor:pointer; font-weight:bold;
    }
    .btn.active { background:var(--g); color:#000; }
    .input {
      background:#111; color:var(--g); border:1px solid var(--g);
      padding:8px 10px; min-width:260px;
    }
    .panel { background:var(--panel); border:1px dashed var(--g); padding:10px; }
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #0f0; padding:8px; font-size:13px; }
    th { background:#061; text-align:left; }
    tr:nth-child(odd) td { background:#050; background:rgba(0,255,102,0.05); }
    code { background:#111; padding:2px 4px; }
    .muted { opacity:.85; }
    .right { text-align:right; }
    .copy { cursor:pointer; text-decoration:underline; }
    .hidden { display:none; }
  </style>
</head>
<body>
  <nav>
    <a href="/">üè† Home</a>
    <a href="/pledge">üî• Pledge</a>
    <a href="/viewer"><strong>üì¶ Viewer</strong></a>
    <a href="/wallet">üíº Wallet</a>
    <a href="/send">üí∏ Send</a>
  </nav>

  <div class="wrap">
    <h1>üì¶ Thronos Viewer</h1>

    <div class="toolbar">
      <button id="btnBlocks" class="btn active">Blocks</button>
      <button id="btnTx" class="btn">Transfers</button>

      <input id="search" class="input" placeholder="Search (address or tx id)" />
      <button id="btnClear" class="btn">Clear</button>
    </div>

    <!-- Blocks table -->
    <div id="blocksPanel" class="panel">
      <table id="blocksTable">
        <thead>
          <tr>
            <th>#</th>
            <th>Block Hash</th>
            <th>Miner THR</th>
            <th class="right">Reward</th>
            <th class="right">Pool Fee</th>
            <th class="right">To Miner</th>
            <th>Timestamp</th>
          </tr>
        </thead>
        <tbody><!-- filled by JS --></tbody>
      </table>
    </div>

    <!-- TX table -->
    <div id="txPanel" class="panel hidden">
      <table id="txTable">
        <thead>
          <tr>
            <th>TX ID</th>
            <th>Height</th>
            <th>From</th>
            <th>To</th>
            <th class="right">Amount</th>
            <th class="right">Fee</th>
            <th>Timestamp</th>
            <th>Copy</th>
          </tr>
        </thead>
        <tbody><!-- filled by JS --></tbody>
      </table>
      <p class="muted">Tip: Œ∫Œ¨ŒΩŒµ Œ∫ŒªŒπŒ∫ œÉŒµ Œ¥ŒπŒµœçŒ∏œÖŒΩœÉŒ∑ Œ≥ŒπŒ± Œ¨ŒΩŒøŒπŒ≥ŒºŒ± wallet viewer ŒÆ œÉœÑŒ∑ŒΩ ¬´Copy¬ª Œ≥ŒπŒ± Œ±ŒΩœÑŒπŒ≥œÅŒ±œÜŒÆ TX/Œ¥ŒπŒµœçŒ∏œÖŒΩœÉŒ∑œÇ.</p>
    </div>
  </div>

  <script>
    const el = (q) => document.querySelector(q);
    const blocksPanel = el("#blocksPanel");
    const txPanel     = el("#txPanel");
    const btnBlocks   = el("#btnBlocks");
    const btnTx       = el("#btnTx");
    const searchBox   = el("#search");
    const btnClear    = el("#btnClear");

    let allBlocks = [];    // ŒºœåŒΩŒø block entries
    let allTxs    = [];    // ŒºœåŒΩŒø transfers

    function show(panel) {
      if (panel === "blocks") {
        blocksPanel.classList.remove("hidden");
        txPanel.classList.add("hidden");
        btnBlocks.classList.add("active");
        btnTx.classList.remove("active");
      } else {
        txPanel.classList.remove("hidden");
        blocksPanel.classList.add("hidden");
        btnTx.classList.add("active");
        btnBlocks.classList.remove("active");
      }
    }

    btnBlocks.onclick = () => show("blocks");
    btnTx.onclick     = () => show("tx");

    btnClear.onclick = () => {
      searchBox.value = "";
      renderBlocks(allBlocks);
      renderTxs(allTxs);
    };

    function copy(text) {
      navigator.clipboard.writeText(text);
      alert("Copied:\n" + text);
    }

    function linkAddr(addr) {
      return `<a href="/wallet/${addr}" target="_blank" style="color:#0f0">${addr}</a>`;
    }

    function renderBlocks(rows) {
      const q = searchBox.value.trim().toLowerCase();
      const body = el("#blocksTable tbody");
      body.innerHTML = "";

      rows
        .filter(b => !q ||
          String(b.block_hash||"").toLowerCase().includes(q) ||
          String(b.thr_address||"").toLowerCase().includes(q)
        )
        .forEach(b => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${(b.block_hash||"").startsWith("THR-") ? (b.block_hash||"").split("-")[1] : ""}</td>
            <td><span class="copy" onclick='(${copy}).call(null, "${b.block_hash}")'>${b.block_hash}</span></td>
            <td>${b.thr_address ? linkAddr(b.thr_address) : ""}</td>
            <td class="right">${Number(b.reward||0).toFixed(3)}</td>
            <td class="right">${Number(b.pool_fee||0).toFixed(3)}</td>
            <td class="right">${Number(b.reward_to_miner||0).toFixed(3)}</td>
            <td>${b.timestamp||""}</td>
          `;
          body.appendChild(tr);
        });
    }

    function renderTxs(rows) {
      const q = searchBox.value.trim().toLowerCase();
      const body = el("#txTable tbody");
      body.innerHTML = "";

      rows
        .filter(t => !q ||
          String(t.tx_id||"").toLowerCase().includes(q) ||
          String(t.from||"").toLowerCase().includes(q) ||
          String(t.to||"").toLowerCase().includes(q)
        )
        .forEach(t => {
          const tr = document.createElement("tr");
          const copyTx = `(${copy}).call(null, "${t.tx_id}")`;
          const copyFrom = `(${copy}).call(null, "${t.from}")`;
          const copyTo   = `(${copy}).call(null, "${t.to}")`;

          tr.innerHTML = `
            <td><span class="copy" onclick='${copyTx}'>${t.tx_id}</span></td>
            <td>${t.height ?? ""}</td>
            <td>${t.from ? linkAddr(t.from) : ""}</td>
            <td>${t.to ? linkAddr(t.to) : ""}</td>
            <td class="right">${Number(t.amount||0).toFixed(6)}</td>
            <td class="right">${Number(t.fee_burned||0).toFixed(4)}</td>
            <td>${t.timestamp||""}</td>
            <td>
              <span class="copy" onclick='${copyTx}'>TX</span> |
              <span class="copy" onclick='${copyFrom}'>From</span> |
              <span class="copy" onclick='${copyTo}'>To</span>
            </td>
          `;
          body.appendChild(tr);
        });
    }

    async function loadData() {
      // Œ¶Œ≠œÅŒΩŒøœÖŒºŒµ ŒüŒõŒü œÑŒø chain Œ∫Œ±Œπ œÜŒπŒªœÑœÅŒ¨œÅŒøœÖŒºŒµ blocks client-side
      const chain = await fetch("/chain").then(r=>r.json());
      allBlocks = chain.filter(x => typeof x === "object" && x && x.type !== "transfer");

      // Œ¶Œ≠œÅŒΩŒøœÖŒºŒµ œÑŒ± transfers Œ±œÄœå œÑŒø ŒΩŒ≠Œø endpoint (ŒÆ Œ∏Œ± ŒºœÄŒøœÅŒøœçœÉŒ±ŒºŒµ ŒΩŒ± œÑŒ± œÜŒπŒªœÑœÅŒ¨œÅŒøœÖŒºŒµ ŒµœÄŒØœÉŒ∑œÇ Œ±œÄœå /chain)
      allTxs = await fetch("/transactions").then(r=>r.json());

      // RENDER
      renderBlocks(allBlocks);
      renderTxs(allTxs);
    }

    searchBox.addEventListener("input", () => {
      renderBlocks(allBlocks);
      renderTxs(allTxs);
    });

    loadData();
  </script>
</body>
</html>
