<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ”¥ Pledge to the Flame â€“ Thronos</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body {
      background: #000;
      color: #0f0;
      font-family: Consolas, "Courier New", monospace;
    }
    a { color: #0f0; }
    .container {
      max-width: 900px;
      margin: 40px auto;
      border: 1px solid #0f0;
      padding: 20px 30px 40px;
    }
    h1 {
      text-align: center;
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 5px;
      font-weight: bold;
    }
    input[type="text"],
    textarea {
      width: 100%;
      background: #000;
      color: #0f0;
      border: 1px solid #0f0;
      padding: 8px;
      box-sizing: border-box;
    }
    textarea {
      min-height: 80px;
      resize: vertical;
    }
    .btn {
      margin-top: 20px;
      background: #0f0;
      color: #000;
      border: none;
      padding: 8px 16px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .panel {
      margin-top: 25px;
      border: 1px dashed #0f0;
      padding: 10px 15px;
      font-size: 13px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .small-note {
      font-size: 11px;
      color: #9f9;
      margin-top: 4px;
    }
    .qr-box {
      text-align: center;
      margin-top: 25px;
      padding: 15px;
      border: 1px dashed #0f0;
    }
    .link-btn {
      display: inline-block;
      margin-top: 10px;
      padding: 6px 10px;
      background: #000;
      border: 1px solid #0f0;
      text-decoration: none;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”¥ Pledge to the Flame</h1>

    <label for="btc_address">BTC Address (KYC):</label>
    <input id="btc_address" type="text" placeholder="Ï€.Ï‡. 1FQov4Byz..." />

    <label for="pledge_text">Your Pledge:</label>
    <textarea id="pledge_text">I hereby pledge allegiance to the Thronos Chain.</textarea>

    <label for="user_passphrase">Secret Passphrase (optional):</label>
    <input id="user_passphrase" type="text" placeholder="ÎœÎ¹Î± Ï†ÏÎ¬ÏƒÎ· Ï€Î¿Ï… Î¼ÏŒÎ½Î¿ ÎµÏƒÏ Î¾Î­ÏÎµÎ¹Ï‚" />
    <div class="small-note">
      â€¢ Î‘Î½ Î²Î¬Î»ÎµÎ¹Ï‚ passphrase, Ï„Î¿ Î´Î¹ÎºÎ±Î¯Ï‰Î¼Î± Î±Ï€Î¿ÏƒÏ„Î¿Î»Î®Ï‚ THR Î±Ï€Î±Î¹Ï„ÎµÎ¯: (PDF + Î±Ï…Ï„Î® Ï„Î· Ï†ÏÎ¬ÏƒÎ·).<br/>
      â€¢ Î§Î¬ÏƒÎµÎ¹Ï‚ ÎºÎ±Î¹ Ï„Î± Î´ÏÎ¿ â†’ ÏŒÏ€Ï‰Ï‚ ÏƒÎµ Ï€ÏÎ±Î³Î¼Î±Ï„Î¹ÎºÏŒ seed, Î´ÎµÎ½ Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ recovery.
    </div>

    <div class="qr-box">
      <div>Send a minimum BTC fee to:</div>
      <div id="btc_receiver">1QFeDPwEF8yEgPEfP79hpc8pHytXMz9oEQ</div>
      <img src="/static/btc_pledge_qr.png" alt="BTC pledge QR" style="margin-top:10px;" />
    </div>

    <button id="btn_submit" class="btn">Submit Pledge</button>

    <div id="result_panel" class="panel" style="display:none;"></div>
  </div>

  <script>
    async function submitPledge() {
      const btn         = document.getElementById("btn_submit");
      const btcAddress  = document.getElementById("btc_address").value.trim();
      const pledgeText  = document.getElementById("pledge_text").value.trim();
      const passphrase  = document.getElementById("user_passphrase").value.trim();
      const resultPanel = document.getElementById("result_panel");

      if (!btcAddress) {
        alert("Î”ÏÏƒÎµ BTC address.");
        return;
      }

      btn.disabled = true;
      resultPanel.style.display = "block";
      resultPanel.textContent = "Submitting pledgeâ€¦";

      try {
        const payload = {
          btc_address: btcAddress,
          pledge_text: pledgeText,
        };
        if (passphrase) {
          payload.user_passphrase = passphrase;
        }

        const resp = await fetch("/pledge_submit", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        const data = await resp.json();

        if (!resp.ok) {
          resultPanel.textContent = "Error: " + (data.error || "unknown");
          btn.disabled = false;
          return;
        }

        if (data.status === "pending") {
          resultPanel.textContent =
            "Status: PENDING\n\n" +
            "Waiting for BTC payment from: " + btcAddress +
            "\n\nTransactions:\n" + JSON.stringify(data.txns || [], null, 2);
          btn.disabled = false;
          return;
        }

        if (data.status === "already_verified" || data.status === "verified") {
          let txt = "";
          txt += "Status: " + data.status.toUpperCase() + "\n\n";
          txt += "THR Address: " + (data.thr_address || "") + "\n";
          txt += "Pledge Hash: " + (data.pledge_hash || "") + "\n";

          if (data.send_secret) {
            txt += "\n=== SEND SECRET (auth_secret) ===\n";
            txt += data.send_secret + "\n";
            txt += "âš  ÎšÏÎ¬Ï„Î± Ï„Î¿ Î±Ï…Ï„ÏŒ ÎšÎ¡Î¥Î¦ÎŸ. Î˜Î± Ï„Î¿ Ï‡ÏÎµÎ¹Î±ÏƒÏ„ÎµÎ¯Ï‚ ÏƒÏ„Î¿ /send Ï‰Ï‚ auth_secret.\n";
            if (data.has_passphrase) {
              txt += "\n(ÎœÏ€Î¿ÏÎµÎ¯Ï‚ Î½Î± Ï„Î¿ Î¾Î±Î½Î±Î²Î³Î¬Î»ÎµÎ¹Ï‚ Î±ÏÎ³ÏŒÏ„ÎµÏÎ± Î±Ï€ÏŒ Ï„Î¿ PDF + Ï„Î· Ï†ÏÎ¬ÏƒÎ· ÏƒÎ¿Ï….)\n";
            } else {
              txt += "\n(Î‘Î½ Ï„Î¿ Ï‡Î¬ÏƒÎµÎ¹Ï‚, recovery Î³Î¯Î½ÎµÏ„Î±Î¹ ÎœÎŸÎÎŸ Î¼Îµ Ï„Î¿ PDF â€“ ÏŒÏ„Î±Î½ Î²Î³Î¬Î»Î¿Ï…Î¼Îµ decoder.)\n";
            }
          } else {
            txt += "\n(Î”ÎµÎ½ ÎµÏ€Î¹ÏƒÏ„ÏÎ­Ï†ÎµÏ„Î±Î¹ send_secret â€“ Î¼Î¬Î»Î»Î¿Î½ Î®Ï„Î±Î½ Î®Î´Î· verified.)\n";
          }

          if (data.pdf_filename) {
            const pdfUrl = "/contracts/" + data.pdf_filename;
            txt += "\nDownload Contract PDF:\n" + pdfUrl + "\n";

            resultPanel.innerHTML =
              txt.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/\n/g, "<br/>") +
              '<br/><br/><a class="link-btn" href="' + pdfUrl + '" target="_blank">Download Contract PDF</a>' +
              '<br/><a class="link-btn" href="/wallet?thr=' + (data.thr_address || "") + '">Go to Wallet</a>';
          } else {
            resultPanel.innerHTML = txt.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/\n/g, "<br/>");
          }

          btn.disabled = false;
          return;
        }

        resultPanel.textContent = "Unexpected response:\n" + JSON.stringify(data, null, 2);
      } catch (err) {
        console.error(err);
        resultPanel.textContent = "Client error: " + err;
      } finally {
        btn.disabled = false;
      }
    }

    document.getElementById("btn_submit").addEventListener("click", submitPledge);
  </script>
</body>
</html>
